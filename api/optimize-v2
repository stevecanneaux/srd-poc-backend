{
  "openapi": "3.1.0",
  "info": { "title": "SRD PoC Backend API â€“ V2", "version": "2.0.0" },
  "servers": [{ "url": "https://srd-poc-backend.vercel.app/api" }],
  "components": {
    "schemas": {
      "Coordinate": {
        "type": "object",
        "required": ["lat", "lng"],
        "properties": { "lat": { "type": "number" }, "lng": { "type": "number" } }
      },
      "VehicleType": {
        "type": "string",
        "enum": ["van_only","van_tow","small_ramp","hiab_grabber","lorry_recovery","moto_recovery","moto_repair"]
      },
      "IssueType": { "type": "string", "enum": ["repair","repair_possible_recovery","recovery_only"] },
      "Vehicle": {
        "type": "object",
        "required": ["id","type","location","shiftEnd"],
        "properties": {
          "id": { "type": "string" },
          "type": { "$ref": "#/components/schemas/VehicleType" },
          "location": { "$ref": "#/components/schemas/Coordinate" },
          "shiftEnd": { "type": "string", "format": "date-time" },
          "capabilities": { "type": "array", "items": { "type": "string" } },
          "allowOvertime": { "type": "boolean", "default": false }
        }
      },
      "JobV2": {
        "type": "object",
        "required": ["id","pickup","issueType","vehicleSize","homeFallback"],
        "properties": {
          "id": { "type": "string" },
          "pickup": { "$ref": "#/components/schemas/Coordinate" },
          "issueType": { "$ref": "#/components/schemas/IssueType" },
          "vehicleSize": { "type": "string", "enum": ["motorcycle","small_car","standard_car","van","lorry"] },
          "preferredDropPlaceId": { "type": "string" },
          "secondaryDropPlaceId": { "type": "string" },
          "homeFallback": { "$ref": "#/components/schemas/Coordinate" },
          "priority": { "type": "integer", "default": 0 }
        }
      },
      "PoliciesV2": {
        "type": "object",
        "properties": {
          "maxLegMiles": { "type": "number", "default": 30 },
          "noNewJobLastMinutes": { "type": "integer", "default": 60 },
          "maxOvertimeMinutes": { "type": "integer", "default": 0 },
          "serviceMinutes": { "type": "integer", "default": 10 },
          "intakeCutoffMinutesBeforeClose": { "type": "integer", "default": 30 },
          "enableMeetAndSwap": { "type": "boolean", "default": true }
        }
      },
      "WeeklyHours": {
        "type": "object",
        "properties": {
          "day": { "type": "integer", "minimum": 0, "maximum": 6 },
          "open": { "type": "string", "pattern": "^[0-2][0-9]:[0-5][0-9]$" },
          "close": { "type": "string", "pattern": "^[0-2][0-9]:[0-5][0-9]$" }
        }
      },
      "Garage": {
        "type": "object",
        "required": ["placeId"],
        "properties": {
          "placeId": { "type": "string" },
          "name": { "type": "string" },
          "coords": { "$ref": "#/components/schemas/Coordinate" },
          "openingHours": { "type": "array", "items": { "$ref": "#/components/schemas/WeeklyHours" } }
        }
      },
      "RouteLeg": {
        "type": "object",
        "properties": {
          "from": { "$ref": "#/components/schemas/Coordinate" },
          "to": { "$ref": "#/components/schemas/Coordinate" },
          "miles": { "type": "number" },
          "etaMinutes": { "type": "number" },
          "vehicleId": { "type": "string" },
          "note": { "type": "string" }
        }
      },
      "AssignmentV2": {
        "type": "object",
        "properties": {
          "jobId": { "type": "string" },
          "legs": { "type": "array", "items": { "$ref": "#/components/schemas/RouteLeg" } },
          "dropDecision": { "type": "string", "enum": ["preferred","secondary","home_fallback"] },
          "willExceedShift": { "type": "boolean" },
          "reason": { "type": "string" }
        }
      },
      "OptimizeV2Request": {
        "type": "object",
        "required": ["now","jobs","vehicles"],
        "properties": {
          "now": { "type": "string", "format": "date-time" },
          "jobs": { "type": "array", "items": { "$ref": "#/components/schemas/JobV2" } },
          "vehicles": { "type": "array", "items": { "$ref": "#/components/schemas/Vehicle" } },
          "garages": { "type": "array", "items": { "$ref": "#/components/schemas/Garage" } },
          "policies": { "$ref": "#/components/schemas/PoliciesV2" }
        }
      },
      "OptimizeV2Response": {
        "type": "object",
        "properties": {
          "assignments": { "type": "array", "items": { "$ref": "#/components/schemas/AssignmentV2" } },
          "unassigned": { "type": "array", "items": { "type": "string" } },
          "notes": { "type": "string" }
        }
      }
    }
  },
  "paths": {
    "/optimize-v2": {
      "post": {
        "operationId": "postOptimizeV2",
        "summary": "Optimise with 30-mile leg rule, cut-offs, shift limits, and meet-and-swap heuristic",
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OptimizeV2Request" } } }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/OptimizeV2Response" } } }
          }
        }
      }
    }
  }
}
